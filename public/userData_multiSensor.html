<!-- This is the userData_multiSensor.html page. It is the third page that loads after the doctor log in from the 'doctorLogin.html' page is successful -->
<!-- This page shows various patient information, along with their credentials, multiple health parameter graphs, and location -->

<!DOCTYPE html>
<html lang="en">
  <head>  <!-- 'head' tag contains all the APIs/libraries to include in our code -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- To add firebase database and firebase Authentication services to our WebApp, we use the following 3 lines of code-->
    <script src="https://www.gstatic.com/firebasejs/6.2.4/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.2.4/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.2.4/firebase-auth.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity=""crossorigin=""/>  <!--this is the css of leaflet API, which helps us to display map -->
    <!-- Include Leaflet JavaScript file after Leafletâ€™s CSS: -->
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity=""crossorigin=""></script>
          
    <!-- The Canvas library/file help to display graphs of patient health parameters -->
    <script type="text/javascript" src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>  <!-- javascript file of canvas API-->

    <!-- p5 library simplifies some of the javascript code implementation -->
    <script language = "javascript" type="text/javascript" src="p5/p5.js"></script>
    <script language = "javascript" type="text/javascript" src="p5/addons/p5.dom.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>  <!-- To use jQuery (javascript library), -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">  <!-- it is a css library added for styling -->
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

    <link rel="stylesheet" href="css/userData_multiSensor.css"> <!-- here we call the css file associated with the 'userData_multiSensor.html' file-->
  </head>

  <body>

    <!-- '#main is responsible for shifting everything to the right as overlay opens' -->
    <div id="main">
      <!-- TopNav tag contains the code responsible for showing the 'SideBar', 'Date', 'Time', 'CSV download' and the 'logOut' buttons in the top navigation bar-->
      <div class="topnav" id="myTopnav">
        <a style="font-size:20px" class="fa fa-user" onclick="openNav()"></a>  <!-- open the sidebar when 'patient icon is clicked'-->

        <!-- This block of code shows the date dropdown menu -->
        <div class="dropdown" id='date-dropdown'>
          <button class="dropdown-button" id='dateButton'><i class="fa fa-calendar"></i> Select Date <i class="fa fa-caret-down"></i></button>
          <div class="dropdown-selection" id='date-dropdown-selection'>
            <!-- we will dynamically create anchor tags <a> here for date-keys -->
          </div>
        </div>
        
        <!-- This block of code shows the time dropdown menu -->
        <div class="dropdown" id='time-dropdown'>
          <button class="dropdown-button" id='timeButton'><i class="fa fa-clock-o"></i> Select Time <i class="fa fa-caret-down"></i></button>
          <div class="dropdown-selection" id='time-dropdown-selection'>
            <!-- we will dynamically create anchor tags <a> here for time-keys -->
          </div>
        </div>

        <a href="#" id='LoadCSV'><i class="fa fa-file-excel-o"></i> Download CSV</a>  <!-- this shows the CSV button at Top Nav Bar -->
        <a href="#" onclick="logout()"><i class="fa fa-sign-out"></i> Logout</a> <!-- this shows the Logout button at Top Nav Bar -->
        <a href="userData_singleSensor.html">Click for Single-Sensor Data</a> <!-- this shows a button at Top Nav Bar which when clicked takes us to another page showing single sensor data of patients -->
        <a href="javascript:void(0);" style="font-size:15px;" class="icon" onclick="myFunction()">&#9776;</a>
      </div>
    
      <!-- "content" comprises the area that has vital data, graphs, map, etc.-->
      <div class = "content">
        <section>
          <div class="adresse">
            <h2>Patient</h2>  
            <hr style="width:95%; float:center; margin-top: -10px; margin-left: 2.2%;" />
            <div class="row">
              <!-- this 'column' tag shows that layout section which contains the patient info i.e. his/her profile picture, name, age and vital data -->
              <div class="column">
                <img id="patientPhoto" src="#" style="width:200px;">
                <p id="patientName" style=" padding-top: 2%;">Name:</p>
                <hr style="width:95%; float:center; margin-top: -10px; margin-left: 3%;" />
                <p id="patientAge">Age:</p>
                <hr style="width:95%; float:center; margin-top: -10px; margin-left: 3%;" />
                <p id="patientBloodGroup">Blood Group:</p>
                <hr style="width:95%; float:center; margin-top: -10px; margin-left: 3%;" />
                <p id="patientECG">ECG:</p>
                <hr style="width:95%; float:center; margin-top: -10px; margin-left: 3%;" />
                <p id="patientEMG">EMG:</p>
                <hr style="width:95%; float:center; margin-top: -10px; margin-left: 3%;" />
                <p id="patientGSR">GSR:</p>
                <hr style="width:95%; float:center; margin-top: -10px; margin-left: 3%;" />
                <p id="patientHeartBeat">Pulse:</p>
                <hr style="width:95%; float:center; margin-top: -10px; margin-left: 3%;" />
                <p id="patientTemp">Temp:</p>
                <hr style="width:95%; float:center; margin-top: -10px; margin-left: 3%;" />
                <p id="patientLatitude">Latitude:</p>
                <hr style="width:95%; float:center; margin-top: -10px; margin-left: 3%;" />
                <p id="patientLongitude">Longitude:</p>
                <hr style="width:95%; float:center; margin-top: -10px; margin-left: 3%;" />
              </div>

              <!-- this 'column' tag shows that layout section which contains the patient prescription related layout (i.e., prescription input box, prescription date and time dropdown buttons, 'post-prescription-to-database button' and 'show-prescription' button) -->
              <div class="column" class="secondColumn" style="background-color:#bbb;">
                <form name="frm">
                  <input class="prescriptionBox" id="prescriptionBoxID" type="text" name="presc" placeholder="Prescription..." value="" disabled required /></br>
                </form>
                <button class="prescriptionButton" onclick="postPrescription()">Post Prescription</button>  <!-- on clicking the 'prescriptionButton', the 'prescription' is sent to database -->  
                <div id="prescriptionMessage" style="display:none; margin-top: 2%;">Prescription Posted!</div> <!-- this div is hidden by default, it is only visible for 1 second, when 'prescriptionButton' button is pressed -->
                <div style= "margin-top: 5%;">

                  <!-- The following div container has code for Dropdown Date Button for Prescription Date menu -->
                  <div class="prescription-dropdown" id='prescription-date-dropdown'>
                    <button class="prescription-dropdown-button" id='prescription-dateButton'><i class="fa fa-calendar"></i> Select Date <i class="fa fa-caret-down"></i></button>
                    <div class="prescription-dropdown-selection" id='prescription-date-dropdown-selection'>
                      <!-- we will dynamically create anchor tags <a> here for date-keys -->
                    </div>
                  </div>

                  <!-- The following div container has code for Dropdown Time Button for Prescription Time menu -->
                  <div class="prescription-dropdown" id='prescription-time-dropdown' style="float: right;">
                    <button class="prescription-dropdown-button" id='prescription-timeButton'><i class="fa fa-clock-o"></i> Select Time <i class="fa fa-caret-down"></i></button>
                    <div class="prescription-dropdown-selection" id='prescription-time-dropdown-selection'>
                      <!-- we will dynamically create anchor tags <a> here for time-keys -->
                    </div>
                  </div>

                </div>

                <!-- The following div container shows the prescription on a selected Date and Time -->
                <div id="patientPrescription" style= "margin-top: 12%; float: center"> Prescription:</div>
              </div>
            </div>

            <h2 style=" padding-top: 5%;">Location Information</h2> 
            <hr style="width:95%; float:center; margin-top: -10px; margin-left: 2.2%;" />
          </div>
              
          <div id="mapid"></div>  <!-- "#mapid" shows the location information on a map -->
        
          <div class="adresse">
            <h2 style=" padding-top: 5%;">MultiLine Information</h2>
            <hr style="width:95%; float:center; margin-top: -10px; margin-left: 2.2%;" /></br>
          </div>    
          <div id="chartContainer" style="height: 300px; width: 88%; margin-left: 2.2%;"></div>  <!-- "#chartContainer" shows the MultiLine Information (multiple vital data) on a single graph -->
              
          <div class="adresse">
            <h2 style=" padding-top: 5%;">ECG Information</h2>
            <hr style="width:95%; float:center; margin-top: -10px; margin-left: 2.2%;" /></br>
          </div>    
          <div id="EcgChartContainer" style="height: 300px; width: 88%; margin-left: 2.2%;"></div>  <!-- "#EcgChartContainer" shows the ecg information on a graph -->
              
          <div class="adresse">
            <h2 style=" padding-top: 5%;">EMG Information</h2>
            <hr style="width:95%; float:center; margin-top: -10px; margin-left: 2.2%;" /></br>
          </div>
          <div id="EmgChartContainer" style="height: 300px; width: 88%; margin-left: 2.2%;"></div>  <!-- "#EmgChartContainer" shows the emg information on a graph -->
            
          <div class="adresse">
            <h2 style=" margin-top: 10%;">GSR Information</h2>
            <hr style="width:95%; float:center; margin-top: -10px; margin-left: 2.2%;" /></br>
          </div>    
          <div id="GSRChartContainer" style="height: 300px; width: 88%; margin-left: 2.2%;"></div>  <!-- "#GSRChartContainer" shows the gsr information on a graph -->    
              
          <div class="adresse">
            <h2 style=" padding-top: 5%;">Heart Beat Information</h2>
            <hr style="width:95%; float:center; margin-top: -10px; margin-left: 2.2%;" /></br>
          </div>    
          <div id="HeartBeatChartContainer" style="height: 300px; width: 88%; margin-left: 2.2%;"></div>  <!-- "#HeartBeatChartContainer" shows the HeartBeat information on a graph -->
        
          <div class="adresse">
            <h2 style=" padding-top: 5%;">Temperature Information</h2>
            <hr style="width:95%; float:center; margin-top: -10px; margin-left: 2.2%;" /></br>
          </div>    
          <div id="TempChartContainer" style="height: 300px; width: 88%; margin-left: 2.2%;"></div>  <!-- "#TempChartContainer" shows the Temperature information on a graph -->
        </section>
      </div>

      <div id="myMenuItems" class="menuItems">   <!--shows sidebar elements containing patients' list -->
      </div>
    </div>
      
    <!-- This 'script' tag is responsible for downloading 'multi-sensor' patient CSV -->
    <script> 
      var _ref, _userLevelKeys, _arrUserLevelKeys, _user, _name, _age, _bloodGroup, _dateRef, _dateLevelKeys, _arrDateLevelKeys, _date, _timeRef, _timeLevelKeys, _arrTimeLevelKeys, _time, _ecg, _emg, _gsr, _pulse, _temp, _lat, _lon, i, j, k;
      LoadCSV.addEventListener('click', (e) => {
        let data = "";
        const tableData = [];
        var rows = [['Patient Name', 'Date', 'Time', 'Age', 'Blood Group', 'ECG', 'EMG', 'GSR', 'Pulse', 'Temp', 'Latitude', 'Longitude']];  // different header names of csv file

        _ref = firebase.database().ref('User_Info');   // store the 'User_Info' path in variable '_ref'
        _ref.on('value', _got_Ref, _err_Ref);  // if any change occurs in the above path, call the function '_got_ref'. If any error occurs while looking for above path, call '_err_ref'

        function _got_Ref(data) {
          _userLevelKeys = data.val();
          _arrUserLevelKeys = Object.keys(_userLevelKeys); // array of all parent keys in the 'User_Info' path
                  
          for (i = 0; i < _arrUserLevelKeys.length; i++) {
            _user = _arrUserLevelKeys[i];  // _user = MJQMe8q7fzvu5lzm9mp for i=0
            _name = _userLevelKeys[_user]["name"];  // store the user name in variable '_name'
            console.log("_name "+_name);                             //(1st entry of csv)
            _age = _userLevelKeys[_user]["age"];  // store the user age in variable '_age'
            console.log("_age " + _age);                             //(4th entry of csv)
            _bloodGroup = _userLevelKeys[_user]["bloodGroup"];  // store the user blood group in variable '_bloodGroup'
            console.log("_bloodGroup " + _bloodGroup);               //(5th entry of csv)

            _dateRef = firebase.database().ref('User_Timestamp_MultiSensor/' + _user);  // now store the 'User_Timestamp_MultiSensor's user path' in variable '_dateRef'
            _dateRef.on('value', _got_dateRef, _err_dateRef);  // if any change occurs in the above path, call the function '_got_dateRef'. If any error occurs while looking for above path, call '_err_dateRef'
          }
        }

        function _got_dateRef(data) {
          if(data.val()===null) {  // it means, if the 'User_Timestamp_MultiSensor' path doesn't exist, then,
            _date = "null";  // set '_date' equals null ...
            _time = "null";
            _ecg = "null";
            _emg = "null";
            _gsr = "null";
            _pulse = "null";
            _temp = "null";
            _lat = "null";
            _lon = "null";

            // rows.push() function allows to enter new data in each row of csv file
            rows.push([_name, _date, _time, _age, _bloodGroup, _ecg, _emg, _gsr, _pulse, _temp, _lat, _lon]);
          } else {  //if the 'User_Timestamp_MultiSensor' path exists
            _dateLevelKeys = data.val();
            _arrDateLevelKeys = Object.keys(_dateLevelKeys); //array of all parent keys (user's date keys) of 'User_Timestamp_MultiSensor'
            for (j = 0; j < _arrDateLevelKeys.length; j++) {  // loop via each parent key
              _date = _arrDateLevelKeys[j];  // store the parent key in '_date' variable     //(2nd entry of csv)
              console.log("date " + _date);

              _timeRef = firebase.database().ref('User_Timestamp_MultiSensor/' + _user + '/' + _date);    // now store the 'User_Timestamp_MultiSensor's date path' in variable '_timeRef'. This path contains all 'time' parent keys
              _timeRef.on('value', _got_timeRef, _err_timeRef);  // if any change occurs in the above path, call the function '_got_timeRef'. If any error occurs while looking for above path, call '_err_timeRef'
            }
          }
        }

        function _got_timeRef(data) {
          _timeLevelKeys = data.val();
          _arrTimeLevelKeys = Object.keys(_timeLevelKeys); //array of all user's date's time keys in 'User_Timestamp_MultiSensor' path
                  
          for (k = 0; k < _arrTimeLevelKeys.length; k++) {  // loop via each time key
            _time = _arrTimeLevelKeys[k];  // _time=10:38:04.404 for k=0   //(3 entry of csv)
            _ecg = _timeLevelKeys[_time]["ECG"];     
            console.log("ecg "+ _ecg);                                     //(6 entry of csv)
            _emg = _timeLevelKeys[_time]["EMG"];
            console.log("emg " + _emg);                                    //(7 entry of csv)
            _gsr = _timeLevelKeys[_time]["GSR"];  
            console.log("gsr " + _gsr);                                    //(8 entry of csv)
            _pulse = _timeLevelKeys[_time]["Pulse"];
            console.log("pulse " + _pulse);                                //(9 entry of csv)
            _temp = _timeLevelKeys[_time]["Temp"];                         //(10 entry of csv)
            console.log("temp " + _temp);  
            _lat = _timeLevelKeys[_time]["Latitude"];        
            console.log("lat " + _lat);                                    //(11 entry of csv)
            _lon = _timeLevelKeys[_time]["Longitude"];
            console.log("lon " + _lon);                                    //(12 entry of csv)
            rows.push([_name, _date, _time, _age, _bloodGroup, _ecg, _emg, _gsr, _pulse, _temp, _lat, _lon]);  // push a new row in the ecg with given params
            console.log("rows: "+rows);   
          }  
        }

        // the remaining code in this block is responsible for naming the csv file and saving it in the desired location
        for (const row of rows) {
          const rowData = [];
          for (const column of row) {
            rowData.push(column);
          }
          tableData.push(rowData.join(","));
        }
        
        data += tableData.join("\n");
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([data], { type: "text/csv" }));
        a.setAttribute("download", "patient_MultiSensorData.csv");
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });

      function _err_Ref(err) {
        console.log('Error!');
        console.log(err);
      }

      function _err_dateRef(err) {
        console.log('Error!');
        console.log(err);
      }

      function _err_timeRef(err) {
        console.log('Error!');
        console.log(err);
      }
    </script>

    <!--  To open the side Nav Bar when "Patient Icon" button is clicked -->
    <script>
      function openNav() { // if button is clicked,
        if (document.getElementById("myMenuItems").style.width == "250px") {  // and sidebar is open,
          document.getElementById("myMenuItems").style.width = "0";  // then close it
          document.getElementById("main").style.marginLeft = "0";
        } else {
          document.getElementById("myMenuItems").style.width = "250px";  // else open it
          document.getElementById("main").style.marginLeft = "250px";
        }
      }
    </script>

    <!-- To make Top Nav Bar responsive, when the window is resized -->
    <script>
      function myFunction() {
        var x = document.getElementById("myTopnav");
        if (x.className === "topnav") {
          x.className += " responsive";
        } else {
          x.className = "topnav";
        }
      }
    </script>

    <script language="javascript" type="text/javascript" src="js/userData_multiSensor.js"></script>
    <!-- load the javascript file associated with this html file -->
  </body>
  
</html>